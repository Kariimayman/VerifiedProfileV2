{"ast":null,"code":"'use strict';\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.diffEpochValidators = exports.findSeatPrice = void 0;\n\nvar bn_js_1 = __importDefault(require(\"bn.js\"));\n/** Finds seat price given validators stakes and number of seats.\n *  Calculation follow the spec: https://nomicon.io/Economics/README.html#validator-selection\n * @params validators: current or next epoch validators.\n * @params numSeats: number of seats.\n */\n\n\nfunction findSeatPrice(validators, numSeats) {\n  var stakes = validators.map(function (v) {\n    return new bn_js_1.default(v.stake, 10);\n  }).sort(function (a, b) {\n    return a.cmp(b);\n  });\n  var num = new bn_js_1.default(numSeats);\n  var stakesSum = stakes.reduce(function (a, b) {\n    return a.add(b);\n  });\n\n  if (stakesSum.lt(num)) {\n    throw new Error('Stakes are below seats');\n  } // assert stakesSum >= numSeats\n\n\n  var left = new bn_js_1.default(1),\n      right = stakesSum.add(new bn_js_1.default(1));\n\n  while (!left.eq(right.sub(new bn_js_1.default(1)))) {\n    var mid = left.add(right).div(new bn_js_1.default(2));\n    var found = false;\n    var currentSum = new bn_js_1.default(0);\n\n    for (var i = 0; i < stakes.length; ++i) {\n      currentSum = currentSum.add(stakes[i].div(mid));\n\n      if (currentSum.gte(num)) {\n        left = mid;\n        found = true;\n        break;\n      }\n    }\n\n    if (!found) {\n      right = mid;\n    }\n  }\n\n  return left;\n}\n\nexports.findSeatPrice = findSeatPrice;\n/** Diff validators between current and next epoch.\n * Returns additions, subtractions and changes to validator set.\n * @params currentValidators: list of current validators.\n * @params nextValidators: list of next validators.\n */\n\nfunction diffEpochValidators(currentValidators, nextValidators) {\n  var validatorsMap = new Map();\n  currentValidators.forEach(function (v) {\n    return validatorsMap.set(v.account_id, v);\n  });\n  var nextValidatorsSet = new Set(nextValidators.map(function (v) {\n    return v.account_id;\n  }));\n  return {\n    newValidators: nextValidators.filter(function (v) {\n      return !validatorsMap.has(v.account_id);\n    }),\n    removedValidators: currentValidators.filter(function (v) {\n      return !nextValidatorsSet.has(v.account_id);\n    }),\n    changedValidators: nextValidators.filter(function (v) {\n      return validatorsMap.has(v.account_id) && validatorsMap.get(v.account_id).stake != v.stake;\n    }).map(function (v) {\n      return {\n        current: validatorsMap.get(v.account_id),\n        next: v\n      };\n    })\n  };\n}\n\nexports.diffEpochValidators = diffEpochValidators;","map":{"version":3,"names":["__importDefault","mod","__esModule","Object","defineProperty","exports","value","diffEpochValidators","findSeatPrice","bn_js_1","require","validators","numSeats","stakes","map","v","default","stake","sort","a","b","cmp","num","stakesSum","reduce","add","lt","Error","left","right","eq","sub","mid","div","found","currentSum","i","length","gte","currentValidators","nextValidators","validatorsMap","Map","forEach","set","account_id","nextValidatorsSet","Set","newValidators","filter","has","removedValidators","changedValidators","get","current","next"],"sources":["D:/Projects/verifiedprofilev2/node_modules/near-api-js/lib/validators.js"],"sourcesContent":["'use strict';\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.diffEpochValidators = exports.findSeatPrice = void 0;\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\n/** Finds seat price given validators stakes and number of seats.\n *  Calculation follow the spec: https://nomicon.io/Economics/README.html#validator-selection\n * @params validators: current or next epoch validators.\n * @params numSeats: number of seats.\n */\nfunction findSeatPrice(validators, numSeats) {\n    const stakes = validators.map(v => new bn_js_1.default(v.stake, 10)).sort((a, b) => a.cmp(b));\n    const num = new bn_js_1.default(numSeats);\n    const stakesSum = stakes.reduce((a, b) => a.add(b));\n    if (stakesSum.lt(num)) {\n        throw new Error('Stakes are below seats');\n    }\n    // assert stakesSum >= numSeats\n    let left = new bn_js_1.default(1), right = stakesSum.add(new bn_js_1.default(1));\n    while (!left.eq(right.sub(new bn_js_1.default(1)))) {\n        const mid = left.add(right).div(new bn_js_1.default(2));\n        let found = false;\n        let currentSum = new bn_js_1.default(0);\n        for (let i = 0; i < stakes.length; ++i) {\n            currentSum = currentSum.add(stakes[i].div(mid));\n            if (currentSum.gte(num)) {\n                left = mid;\n                found = true;\n                break;\n            }\n        }\n        if (!found) {\n            right = mid;\n        }\n    }\n    return left;\n}\nexports.findSeatPrice = findSeatPrice;\n/** Diff validators between current and next epoch.\n * Returns additions, subtractions and changes to validator set.\n * @params currentValidators: list of current validators.\n * @params nextValidators: list of next validators.\n */\nfunction diffEpochValidators(currentValidators, nextValidators) {\n    const validatorsMap = new Map();\n    currentValidators.forEach(v => validatorsMap.set(v.account_id, v));\n    const nextValidatorsSet = new Set(nextValidators.map(v => v.account_id));\n    return {\n        newValidators: nextValidators.filter(v => !validatorsMap.has(v.account_id)),\n        removedValidators: currentValidators.filter(v => !nextValidatorsSet.has(v.account_id)),\n        changedValidators: nextValidators.filter(v => (validatorsMap.has(v.account_id) && validatorsMap.get(v.account_id).stake != v.stake))\n            .map(v => ({ current: validatorsMap.get(v.account_id), next: v }))\n    };\n}\nexports.diffEpochValidators = diffEpochValidators;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}